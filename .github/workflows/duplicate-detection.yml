name: MoFA Duplicate Issue Detection

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

jobs:
  detect-duplicates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current issue details
        id: current_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            core.setOutput('number', issue.number);
            core.setOutput('title', issue.title || '');
            core.setOutput('body', issue.body || '');
            core.setOutput('url', issue.html_url);

      - name: Search for similar open issues
        id: search_issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const currentTitle = `${{ steps.current_issue.outputs.title }}`;
            const currentNumber = ${{ steps.current_issue.outputs.number }};
            
            // Extract key words from title for search
            const searchTerms = currentTitle
              .toLowerCase()
              .replace(/[^\w\s]/g, ' ')
              .split(/\s+/)
              .filter(word => word.length > 3)
              .slice(0, 5)
              .join(' ');
            
            // Search for open issues with similar terms
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open ${searchTerms}`,
              per_page: 20
            });
            
            // Filter out current issue and get issue details
            const candidateIssues = searchResults.items
              .filter(issue => issue.number !== currentNumber)
              .slice(0, 10); // Limit to top 10 candidates
            
            const issuesData = [];
            for (const issue of candidateIssues) {
              try {
                const { data: fullIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                });
                issuesData.push({
                  number: issue.number,
                  title: issue.title,
                  body: fullIssue.body || '',
                  url: issue.html_url,
                  created_at: issue.created_at
                });
              } catch (e) {
                core.warning(`Failed to get details for issue #${issue.number}: ${e.message}`);
              }
            }
            
            core.setOutput('candidates', JSON.stringify(issuesData));
            core.info(`Found ${issuesData.length} candidate issues to check`);

      - name: Analyze duplicates with Gemini
        id: analyze_duplicates
        if: steps.search_issues.outputs.candidates != '[]'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CURRENT_ISSUE_TITLE: ${{ steps.current_issue.outputs.title }}
          CURRENT_ISSUE_BODY: ${{ steps.current_issue.outputs.body }}
          CURRENT_ISSUE_NUMBER: ${{ steps.current_issue.outputs.number }}
          CANDIDATE_ISSUES: ${{ steps.search_issues.outputs.candidates }}
        run: |
          PROMPT=$(cat <<PROMPT_EOF
          You are a duplicate issue detection assistant. Analyze if the current issue is a duplicate of any candidate issues.

          Current Issue:
          Number: ${CURRENT_ISSUE_NUMBER}
          Title: ${CURRENT_ISSUE_TITLE}
          Body:
          ${CURRENT_ISSUE_BODY}

          Candidate Issues:
          ${CANDIDATE_ISSUES}

          INSTRUCTIONS:
          1. Compare the current issue with each candidate issue.
          2. Determine if they describe the same bug, feature request, or problem.
          3. Consider:
             - Are they reporting the same underlying issue?
             - Do they have the same root cause?
             - Would fixing one resolve the other?
          4. If you find a duplicate, identify the BEST canonical issue (usually the one with more details, earlier creation date, or more engagement).
          5. If comments on either issue explicitly state they are NOT duplicates, respect that and don't mark as duplicate.

          Return ONLY a JSON object with this structure:
          {
            "is_duplicate": true or false,
            "canonical_issue_number": number (if duplicate, the issue number to link to),
            "confidence": "high" or "medium" or "low",
            "reason": "brief explanation"
          }

          If is_duplicate is false, canonical_issue_number can be null.
          PROMPT_EOF
          )

          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"role\": \"user\",
                \"parts\": [{\"text\": $(echo "$PROMPT" | jq -Rs .)}]
              }]
            }")

          RESULT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
          
          # Extract JSON from markdown code blocks if present
          if echo "$RESULT" | grep -q '```'; then
            RESULT=$(echo "$RESULT" | sed -n '/```json/,/```/p' | sed '1d;$d' || echo "$RESULT" | sed -n '/```/,/```/p' | sed '1d;$d')
          fi
          
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Close duplicate issue
        if: steps.analyze_duplicates.outputs.result != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = `${{ steps.analyze_duplicates.outputs.result }}`;
            const currentNumber = ${{ steps.current_issue.outputs.number }};
            
            let analysis;
            try {
              analysis = JSON.parse(result);
            } catch (e) {
              core.error(`Failed to parse duplicate analysis: ${e.message}`);
              core.error(`Raw result: ${result}`);
              return;
            }
            
            if (!analysis.is_duplicate || analysis.confidence === 'low') {
              core.info(`Issue #${currentNumber} is not a duplicate (confidence: ${analysis.confidence})`);
              return;
            }
            
            const canonicalNumber = analysis.canonical_issue_number;
            if (!canonicalNumber) {
              core.warning('Duplicate detected but no canonical issue number provided');
              return;
            }
            
            // Add comment
            const comment = `This issue appears to be a duplicate of #${canonicalNumber}.\n\n${analysis.reason || 'Closing as duplicate.'}\n\nPlease follow #${canonicalNumber} for updates.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: currentNumber,
              body: comment
            });
            
            // Close the issue (disabled for manual confirmation flow)
            // await github.rest.issues.update({
            //   owner: context.repo.owner,
            //   repo: context.repo.repo,
            //   issue_number: currentNumber,
            //   state: 'closed',
            //   state_reason: 'not_planned'
            // });
            
            // Add duplicate label if it exists
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: currentNumber,
                labels: ['duplicate']
              });
            } catch (e) {
              core.info('Could not add duplicate label (may not exist)');
            }
            
            core.info(`Closed issue #${currentNumber} as duplicate of #${canonicalNumber}`);
