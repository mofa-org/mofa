name: Triage Low Confidence Review

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  apply-triage:
    if: startsWith(github.event.comment.body, '/triage-apply')
    runs-on: ubuntu-latest
    steps:
      - name: Parse and apply suggested labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get all comments for the issue
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: issueNumber,
              per_page: 100
            });

            // Find the most recent bot comment with triage info
            const botComment = comments
              .reverse()
              .find(c => c.user.login === 'github-actions[bot]' && c.body.includes('### ðŸ¤– Automated Triage (Low Confidence:'));

            if (!botComment) {
              core.setFailed('Could not find a recent automated triage suggestion comment.');
              return;
            }

            core.info(`Found bot comment: ${botComment.id}`);

            // Parse labels to add
            const addMatch = botComment.body.match(/- Add: (.*)/);
            let labelsToAdd = [];
            if (addMatch && addMatch[1] !== '_none_') {
              labelsToAdd = addMatch[1].match(/`([^`]+)`/g).map(l => l.replace(/`/g, ''));
            }

            // Parse labels to remove
            const removeMatch = botComment.body.match(/- Remove: (.*)/);
            let labelsToRemove = [];
            if (removeMatch && removeMatch[1] !== '_none_') {
              labelsToRemove = removeMatch[1].match(/`([^`]+)`/g).map(l => l.replace(/`/g, ''));
            }

            core.info(`Labels to add: ${labelsToAdd.join(', ')}`);
            core.info(`Labels to remove: ${labelsToRemove.join(', ')}`);

            // Apply labels
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: labelsToAdd
              });
            }

            // Remove labels
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  name: label
                });
              } catch (e) {
                core.info(`Could not remove label ${label}: ${e.message}`);
              }
            }

            // Remove status/manual-triage
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: issueNumber,
                name: 'status/manual-triage'
              });
            } catch (e) {
              core.info(`Could not remove status/manual-triage: ${e.message}`);
            }

            // Add a confirmation comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `âœ… Applied suggested labels as requested by @${context.payload.comment.user.login}.`
            });
