name: MoFA Automated Issue Triage

on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to triage'
        required: true
        type: string

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get issue details
        id: issue_details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue.outputs.number }};
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            
            core.setOutput('title', issue.title || '');
            core.setOutput('body', issue.body || '');
            core.setOutput('author', issue.user?.login || '');
            core.setOutput('labels', JSON.stringify(issue.labels.map(l => l.name)));
            core.setOutput('comments', JSON.stringify(comments.map(c => ({
              author: c.user?.login,
              body: c.body
            }))));

      - name: Get repository labels
        id: get_labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: labels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });
            core.setOutput('available_labels', JSON.stringify(labels.map(l => l.name)));

      - name: Read triage prompt
        id: prompt
        run: |
          if [ -f ".github/prompts/issue-triage-prompt.txt" ]; then
            PROMPT=$(cat .github/prompts/issue-triage-prompt.txt)
          else
            echo "Warning: Prompt file not found, using default prompt"
            PROMPT="Analyze this GitHub issue and apply appropriate labels: area/*, kind/*, priority/*"
          fi
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build issue context
        id: build_context
        run: |
          set -euo pipefail
          
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          ISSUE_TITLE="${{ steps.issue_details.outputs.title }}"
          ISSUE_BODY="${{ steps.issue_details.outputs.body }}"
          ISSUE_AUTHOR="${{ steps.issue_details.outputs.author }}"
          ISSUE_LABELS="${{ steps.issue_details.outputs.labels }}"
          ISSUE_COMMENTS="${{ steps.issue_details.outputs.comments }}"
          AVAILABLE_LABELS="${{ steps.get_labels.outputs.available_labels }}"
          
          # Create JSON for single issue
          ISSUE_JSON=$(jq -n \
            --arg number "${ISSUE_NUMBER}" \
            --arg title "${ISSUE_TITLE}" \
            --arg body "${ISSUE_BODY}" \
            --arg author "${ISSUE_AUTHOR}" \
            --argjson labels "${ISSUE_LABELS}" \
            --argjson comments "${ISSUE_COMMENTS}" \
            '[{
              "number": ($number | tonumber),
              "title": $title,
              "body": $body,
              "author": $author,
              "labels": $labels,
              "comments": $comments
            }]')
          
          echo "issues_json<<EOF" >> $GITHUB_OUTPUT
          echo "${ISSUE_JSON}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Triage issue with Gemini
        id: triage
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUES_TO_TRIAGE: ${{ steps.build_context.outputs.issues_json }}
          AVAILABLE_LABELS: ${{ steps.get_labels.outputs.available_labels }}
        run: |
          PROMPT="${{ steps.prompt.outputs.prompt }}"
          
          # Build the full prompt with issue context
          FULL_PROMPT="${PROMPT}
          
          Issue to triage:
          ${ISSUES_TO_TRIAGE}
          
          Available labels:
          ${AVAILABLE_LABELS}
          
          Please analyze the issue and return JSON as specified in the instructions."
          
          # Call Gemini API
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"role\": \"user\",
                \"parts\": [{\"text\": $(echo "$FULL_PROMPT" | jq -Rs .)}]
              }]
            }")
          
          # Extract text from response
          TRIAGE_RESULT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
          
          if [ -z "$TRIAGE_RESULT" ]; then
            echo "Error: No response from Gemini API"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          # Try to extract JSON from markdown code blocks if present
          if echo "$TRIAGE_RESULT" | grep -q '```'; then
            TRIAGE_RESULT=$(echo "$TRIAGE_RESULT" | sed -n '/```json/,/```/p' | sed '1d;$d' || echo "$TRIAGE_RESULT" | sed -n '/```/,/```/p' | sed '1d;$d')
          fi
          
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$TRIAGE_RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.issue.outputs.number }};
            const triageResult = `${{ steps.triage.outputs.result }}`;
            
            let triageData;
            try {
              // Try to parse as JSON array
              triageData = JSON.parse(triageResult);
              if (!Array.isArray(triageData)) {
                triageData = [triageData];
              }
            } catch (e) {
              core.error(`Failed to parse triage result: ${e.message}`);
              core.error(`Raw result: ${triageResult}`);
              return;
            }
            
            // Find the entry for this issue
            const issueTriage = triageData.find(t => t.issue_number === issueNumber);
            if (!issueTriage) {
              core.info(`No triage result found for issue #${issueNumber}`);
              return;
            }
            
            const labelsToAdd = issueTriage.labels_to_add || [];
            const labelsToRemove = issueTriage.labels_to_remove || [];
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labelsToAdd,
              });
              core.info(`Added labels: ${labelsToAdd.join(', ')}`);
            }
            
            if (labelsToRemove.length > 0) {
              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: label,
                  });
                } catch (e) {
                  // Label might not exist, ignore
                  core.info(`Could not remove label ${label}: ${e.message}`);
                }
              }
              core.info(`Removed labels: ${labelsToRemove.join(', ')}`);
            }
            
            if (labelsToAdd.length === 0 && labelsToRemove.length === 0) {
              core.info('No label changes needed');
            }
